### [CVE-2024-57937](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-57937)
![](https://img.shields.io/static/v1?label=Product&message=Linux&color=blue)
![](https://img.shields.io/static/v1?label=Version&message=5de195060b2e251a835f622759550e6202167641%3C%20464770df46095e6967334d77113972960f7ef1fa%20&color=brighgreen)
![](https://img.shields.io/static/v1?label=Vulnerability&message=n%2Fa&color=brighgreen)

### Description

In the Linux kernel, the following vulnerability has been resolved:mm: reinstate ability to map write-sealed memfd mappings read-onlyPatch series "mm: reinstate ability to map write-sealed memfd mappingsread-only".In commit 158978945f31 ("mm: perform the mapping_map_writable() checkafter call_mmap()") (and preceding changes in the same series) it becamepossible to mmap() F_SEAL_WRITE sealed memfd mappings read-only.Commit 5de195060b2e ("mm: resolve faulty mmap_region() error pathbehaviour") unintentionally undid this logic by moving themapping_map_writable() check before the shmem_mmap() hook is invoked,thereby regressing this change.This series reworks how we both permit write-sealed mappings being mappedread-only and disallow mprotect() from undoing the write-seal, fixing thisregression.We also add a regression test to ensure that we do not accidentallyregress this in future.Thanks to Julian Orth for reporting this regression.This patch (of 2):In commit 158978945f31 ("mm: perform the mapping_map_writable() checkafter call_mmap()") (and preceding changes in the same series) it becamepossible to mmap() F_SEAL_WRITE sealed memfd mappings read-only.This was previously unnecessarily disallowed, despite the man pagedocumentation indicating that it would be, thereby limiting the usefulnessof F_SEAL_WRITE logic.We fixed this by adapting logic that existed for the F_SEAL_FUTURE_WRITEseal (one which disallows future writes to the memfd) to also be used forF_SEAL_WRITE.For background - the F_SEAL_FUTURE_WRITE seal clears VM_MAYWRITE for aread-only mapping to disallow mprotect() from overriding the seal - anoperation performed by seal_check_write(), invoked from shmem_mmap(), thef_op->mmap() hook used by shmem mappings.By extending this to F_SEAL_WRITE and critically - checkingmapping_map_writable() to determine if we may map the memfd AFTER weinvoke shmem_mmap() - the desired logic becomes possible.  This is becausemapping_map_writable() explicitly checks for VM_MAYWRITE, which we willhave cleared.Commit 5de195060b2e ("mm: resolve faulty mmap_region() error pathbehaviour") unintentionally undid this logic by moving themapping_map_writable() check before the shmem_mmap() hook is invoked,thereby regressing this change.We reinstate this functionality by moving the check out of shmem_mmap()and instead performing it in do_mmap() at the point at which VMA flags arebeing determined, which seems in any case to be a more appropriate placein which to make this determination.In order to achieve this we rework memfd seal logic to allow us access tothis information using existing logic and eliminate the clearing ofVM_MAYWRITE from seal_check_write() which we are performing in do_mmap()instead.

### POC

#### Reference
No PoCs from references.

#### Github
- https://github.com/fkie-cad/nvd-json-data-feeds

